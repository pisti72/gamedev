var TinyPhysic2D={GRAVITY:-.25,FRICTION:.9,SOFTNESS:.1,BLUR:.8,AIR:.9995,MAG:50,BOX_DRAW_METHOD:0,CLS_METHOD:0,DEBUG:!1,w:0,h:0,camera:{x:0,y:0,lookAt:0},lookAt:function(t){this.camera.lookAt=t},canvas:{},ctx:{},points:[],lines:[],sections:[],boxes:[],init:function(){this.canvas=document.getElementsByTagName("canvas")[0],this.w=this.canvas.width=document.body.clientWidth,this.h=this.canvas.height=document.body.clientHeight-20},addBall:function(t,i,s,e,h,a,n){var l={id:t,r:i,x:s,y:e,fixed:h,soft:n,wheel:a,xv:0,yv:0,collied:!1,linesCount:0,visible:!0,boxId:9999,getDistanceDiff:function(t){return Math.sqrt((t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y))-this.r-t.r},getVector:function(t){var i=Math.sqrt((t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y)),s=t.r+this.r-i;return{x:(this.x-t.x)/i*s,y:(this.y-t.y)/i*s}},getDistanceOfCenter:function(t){var i=t.x-this.x,s=t.y-this.y;return Math.sqrt(i*i+s*s)}};this.points.push(l)},getBallById:function(t){for(var i=0;i<this.points.length;i++){var s=this.points[i];if(s.id==t)return s}},getNumberOfBalls:function(){return this.points.length},addLine:function(t,i,s){var e=this.getBallById(i),h=this.getBallById(s),a={id:t,id1:i,id2:s,length:Math.sqrt((e.x-h.x)*(e.x-h.x)+(e.y-h.y)*(e.y-h.y)),active:!0,visible:!0};this.lines.push(a),this.calculateLineConnectionsToBalls()},getLineById:function(t){for(var i=0;i<this.lines.length;i++)if(this.lines[i].id==t)return this.lines[i]},disableLine:function(t){this.getLineById(t).active=!1,this.calculateLineConnectionsToBalls()},addTrack:function(t,i,s,e){var h={x:t,y:i,w:s,h:e};this.sections.push(h)},addBox:function(t,i,s){for(var e=0,h=0,a=s/2,n=0;n<this.points.length;n++)this.points[n].id>e&&(e=this.points[n].id);for(n=0;n<this.lines.length;n++)this.lines[n].id>h&&(h=this.lines[n].id);this.addBall(++e,a,t+s/2,i+s/2,!1,!1,!1),this.addBall(++e,a,t+1.5*s,i+s/2,!1,!1,!1),this.addBall(++e,a,t+s/2,i+1.5*s,!1,!1,!1),this.addBall(++e,a,t+1.5*s,i+1.5*s,!1,!1,!1),this.addLine(++h,e-3,e-2),this.addLine(++h,e-0,e-1),this.addLine(++h,e-3,e-1),this.addLine(++h,e-2,e-0),this.addLine(++h,e-3,e-0),this.addLine(++h,e-2,e-1),this.getBallById(e-3).boxId=e-3,this.getBallById(e-2).boxId=e-3,this.getBallById(e-1).boxId=e-3,this.getBallById(e-0).boxId=e-3,this.DEBUG||(this.getBallById(e-3).visible=!1,this.getBallById(e-2).visible=!1,this.getBallById(e-1).visible=!1,this.getBallById(e).visible=!1,this.getLineById(h-5).visible=!1,this.getLineById(h-4).visible=!1,this.getLineById(h-3).visible=!1,this.getLineById(h-2).visible=!1,this.getLineById(h-1).visible=!1,this.getLineById(h).visible=!1),this.boxes.push({first_point_id:e-3,size:s})},getNumberOfBoxes:function(){return this.boxes.length},draw:function(){var t=this.canvas.getContext("2d");this.clearCanvas(t),this.drawBalls(t),this.drawLines(t),this.drawTrack(t),this.drawGround(t),this.drawBoxes(t)},clearCanvas:function(t){if(t.lineWidth=2,1==this.CLS_METHOD)for(var i,s,e=0;e<200;e++)i=Math.floor(Math.random()*this.w),s=Math.floor(Math.random()*this.h),t.clearRect(0,s,this.w,2),t.clearRect(i,0,2,this.h);else 2==this.CLS_METHOD?(t.fillStyle="rgba(255,255,255,"+this.BLUR+")",t.fillRect(0,0,this.w,this.h)):t.clearRect(0,0,this.w,this.h)},drawBalls:function(t){for(var i=0;i<this.points.length;i++){var s=this.points[i];t.strokeStyle="#000",s.collied&&this.DEBUG&&(t.strokeStyle="#0f0"),s.visible&&(t.beginPath(),t.arc(s.x+this.camera.x,this.h-s.y-this.camera.y,s.r,0,2*Math.PI),t.stroke())}},drawLines:function(t){t.strokeStyle="#f00";for(var i=0;i<this.lines.length;i++){var s=this.lines[i];if(s.active&&s.visible){t.beginPath();var e=this.getBallById(s.id1),h=this.getBallById(s.id2);t.moveTo(e.x+this.camera.x,this.h-e.y-this.camera.y),t.lineTo(h.x+this.camera.x,this.h-h.y-this.camera.y),t.stroke()}}},drawTrack:function(t){for(var i=0;i<this.sections.length;i++){var s=this.sections[i],e=s.x+this.camera.x;e>-s.w&&e+s.w<this.w+s.w&&(t.strokeStyle="#00f",t.beginPath(),t.moveTo(e,this.h-this.camera.y),t.lineTo(e,this.h-s.y-this.camera.y),t.lineTo(e+s.w,this.h-s.y-s.h-this.camera.y),t.lineTo(e+s.w,this.h-this.camera.y),t.stroke(),0==i&&(t.strokeStyle="#444",t.beginPath(),t.moveTo(e,this.h-s.y-this.camera.y),t.lineTo(e,this.h-s.y-this.camera.y-60),t.lineTo(e+40,this.h-s.y-this.camera.y-50),t.lineTo(e,this.h-s.y-this.camera.y-40),t.stroke()))}},drawGround:function(t){t.strokeStyle="#080",t.beginPath(),t.moveTo(0,this.h-this.camera.y),t.lineTo(this.w,this.h-this.camera.y),t.stroke()},drawBoxes:function(t){t.strokeStyle="#000";for(var i=0;i<this.boxes.length;i++){var s=this.boxes[i],e=this.getBallById(s.first_point_id),h=this.getBallById(s.first_point_id+1),a=this.getBallById(s.first_point_id+2),n=this.getBallById(s.first_point_id+3),l={x:(e.x+h.x+a.x+n.x)/4,y:(e.y+h.y+a.y+n.y)/4},o={x:l.x+2*(e.x-l.x),y:l.y+2*(e.y-l.y)},r={x:l.x+2*(h.x-l.x),y:l.y+2*(h.y-l.y)},y={x:r.x-o.x,y:r.y-o.y},x=Math.sqrt(y.x*y.x+y.y*y.y),c={x:y.x/x*s.size*2,y:y.y/x*s.size*2};if(t.beginPath(),0==this.BOX_DRAW_METHOD){var d=[{x:l.x+2*(e.x-l.x),y:l.y+2*(e.y-l.y)},{x:l.x+2*(h.x-l.x),y:l.y+2*(h.y-l.y)},{x:l.x+2*(a.x-l.x),y:l.y+2*(a.y-l.y)},{x:l.x+2*(n.x-l.x),y:l.y+2*(n.y-l.y)}];t.moveTo(d[0].x+this.camera.x,this.h-d[0].y-this.camera.y),t.lineTo(d[1].x+this.camera.x,this.h-d[1].y-this.camera.y),t.lineTo(d[3].x+this.camera.x,this.h-d[3].y-this.camera.y),t.lineTo(d[2].x+this.camera.x,this.h-d[2].y-this.camera.y),t.lineTo(d[0].x+this.camera.x,this.h-d[0].y-this.camera.y)}1==this.BOX_DRAW_METHOD&&(t.moveTo(o.x+this.camera.x,this.h-o.y-this.camera.y),t.lineTo(o.x+c.x+this.camera.x,this.h-(o.y+c.y)-this.camera.y),t.lineTo(o.x+c.x-c.y+this.camera.x,this.h-(o.y+c.y+c.x)-this.camera.y),t.lineTo(o.x-c.y+this.camera.x,this.h-(o.y+c.x)-this.camera.y),t.lineTo(o.x+camera.x,this.h-o.y-this.camera.y)),t.stroke()}},drawText:function(t,i,s){var e=this.canvas.getContext("2d");e.fillStyle="#000",e.font="20px Arial",e.fillText(t,i,s)},collition:function(){for(var t=0;t<this.points.length;t++){var i=this.points[t];i.collied=!1;var s=this.getBallFromPlane(i);this.collitionHelper(i,s);for(var e=0;e<this.sections.length;e++){var h=this.sections[e],a=h.x;if(i.x>=a&&i.x<a+h.w){s=this.getBallFromSection(a,h.y,h.w,h.h);this.collitionHelper(i,s)}}for(e=0;e<this.points.length;e++){s=this.points[e];if(e!=t&&(9999==i.boxId||i.boxId!=s.boxId)&&i.getDistanceDiff(s)<0){var n=i.getVector(s);i.x+=.5*n.x,i.y+=.5*n.y,i.xv+=n.x,i.yv+=n.y,i.collied=!0}}}},collitionHelper:function(t,i){if(t.getDistanceDiff(i)<0){var s=t.getVector(i);t.soft?(t.x+=s.x*this.SOFTNESS,t.y+=s.y*this.SOFTNESS):(t.x+=s.x,t.y+=s.y),t.xv+=s.x,t.yv+=s.y,t.wheel||(t.xv*=this.FRICTION),t.collied=!0}},getBallFromPlane:function(t){return{x:t.x,y:-MAG,r:MAG}},getBallFromSection:function(t,i,s,e){var h={x:t+s/2+e*this.MAG,y:i+e/2-s*this.MAG},a=t-h.x,n=i-h.y,l=Math.sqrt(a*a+n*n);return{x:h.x,y:h.y,r:l}},forces:function(){for(var t=0;t<this.lines.length;t++){var i=this.lines[t];if(i.active){var s=this.getBallById(i.id1),e=this.getBallById(i.id2),h=s.getDistanceOfCenter(e),a=h-i.length,n=(e.x-s.x)/h*a,l=(e.y-s.y)/h*a;s.fixed||(s.xv+=n/s.linesCount,s.yv+=l/s.linesCount),e.fixed||(e.xv-=n/e.linesCount,e.yv-=l/e.linesCount)}}for(t=0;t<this.points.length;t++){var o=this.points[t];o.fixed||(o.yv+=this.GRAVITY,o.x+=o.xv,o.y+=o.yv,o.xv*=this.AIR,o.yv*=this.AIR)}},calculateLineConnectionsToBalls:function(){for(var t=0;t<this.points.length;t++)this.points[t].linesCount=0;for(t=0;t<this.lines.length;t++){var i=this.lines[t],s=this.getBallById(i.id1),e=this.getBallById(i.id2);i.active&&(s.linesCount++,e.linesCount++)}},update:function(){this.camera.x=-this.getBallById(this.camera.lookAt).x+this.w/2,this.camera.y=-this.getBallById(this.camera.lookAt).y+this.h/2,this.collition(),this.forces()}};